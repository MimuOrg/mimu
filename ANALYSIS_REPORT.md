# Анализ проекта Mimu: что плохо работает или отсутствует

## 1. Критические ошибки

### 1.1 Клиент: `ServerConfig.baseUrl` не существует
- **Где:** `lib/data/services/auth_service.dart` (register, login, refresh), `lib/data/services/crypto_auth_service.dart` (challenge, verify, register-crypto).
- **Суть:** Используется `ServerConfig.baseUrl`, тогда как в `ServerConfig` есть только `getApiBaseUrl()`.
- **Итог:** Либо падение в рантайме (NoSuchMethodError), либо нерабочий legacy/crypto auth, если `baseUrl` нигде не добавлен.
- **Исправление:** В `ServerConfig` добавить `static String get baseUrl => getApiBaseUrl();` либо везде заменить на `ServerConfig.getApiBaseUrl()`.

### 1.2 Бэкенд: маршруты crypto-auth не зарегистрированы
- **Где:** `server/src/web/router.rs`.
- **Суть:** В роутере есть только `/auth/register`, `/auth/login`, `/auth/refresh`, `/auth/reset-password`. Нет маршрутов для:
  - `POST /auth/challenge`
  - `POST /auth/verify`
  - `POST /auth/register-crypto`
- **Итог:** Crypto-auth (Ed25519 challenge-response) на клиенте не работает: эндпоинты не существуют.
- **Исправление:** Подключить `crate::web::auth::crypto_handlers` и добавить в роутер соответствующие `post(...)` для challenge, verify, register_crypto.

---

## 2. Сервер: что не так или не доделано

### 2.1 Сессии: IP не сохраняется
- **Где:** `server/src/web/auth/handlers.rs` — `login()`.
- **Суть:** В `user_sessions` пишется только `user_agent`; поле `ip` в миграции есть, но не заполняется.
- **Исправление:** В `login` извлечь IP из запроса (например, `axum::extract::ConnectInfo` или заголовки `X-Forwarded-For`/`X-Real-IP` за прокси) и передавать в `INSERT INTO user_sessions`.

### 2.2 Кик сессии не отзывает доступ
- **Где:** `server/src/web/sessions/handlers.rs` — `kick_session` только удаляет строку из `user_sessions`.
- **Суть:** JWT и WebSocket у «кикнутого» устройства остаются валидными до истечения срока токена. Устройство продолжает работать.
- **Идея доработки:** Варианты: хранить в Redis blacklist отозванных JWT (или jti) и проверять при каждом запросе/подключении WS; либо короткий TTL JWT + продление через refresh, при кике удалять refresh-токены сессии. Плюс при кике можно слать по WS событие «session_revoked», чтобы клиент сам разлогинился.

### 2.3 Дубликаты миграций
- **Где:** `server/migrations/` — есть `0002_add_pinned_messages.sql` и `0002_add_signing_public_key.sql`.
- **Суть:** Два файла с одним номером могут ломать порядок применения миграций.
- **Исправление:** Переименовать один из них (например, в `0002a_...` и `0002b_...` или сдвинуть нумерацию) и проверить, что схема в БД соответствует ожидаемой.

### 2.4 Поиск пользователей без авторизации
- **Где:** `GET /users/search` — без `Authorization`.
- **Суть:** Любой может искать пользователей по строке. Для публичного мессенджера может быть приемлемо, но для приватности лучше решить: оставить публичный поиск или требовать JWT и ограничить видимость (например, по настройкам приватности).

---

## 3. Клиент: что не так или не доделано

### 3.1 Жалоба в канале — фейковая
- **Где:** `lib/features/channel_screen.dart` — пункт «Пожаловаться» в меню.
- **Суть:** По нажатию показывается только SnackBar «Жалоба отправлена», вызова `UserApi().report(...)` нет.
- **Исправление:** Реализовать диалог (причина, контекст канала/поста), при отправке вызывать `UserApi().report(chatId: ..., decryptedContent: ..., reason: ...)`.

### 3.2 Жалоба на сообщение в чате
- **Где:** `lib/features/chat_screen.dart`.
- **Суть:** В коде нет кнопки/контекстного меню «Пожаловаться» на сообщение. Для модерации нужна возможность пожаловаться на конкретное сообщение, расшифровав его на клиенте и отправив `message_id` + `decrypted_content` в `POST /api/v1/report`.
- **Исправление:** Добавить в контекстное меню сообщения пункт «Пожаловаться», диалог с причиной, расшифровку текста сообщения и вызов `UserApi().report(messageId: ..., chatId: ..., decryptedContent: ..., reason: ...)`.

### 3.3 Конфигурация сервера захардкожена
- **Где:** `lib/data/server_config.dart` — `_defaultMessageServer = 'http://10.147.17.50:8080'`, то же для file/media/voice/sync.
- **Суть:** Для продакшена нужен один конфигурируемый базовый URL (или разные URL через env/build flavour), без локальных IP в коде.
- **Исправление:** Брать базовый URL из переменных окружения / build config / удалённого конфига; в коде оставить только fallback для разработки.

### 3.4 Дублирование кода
- **Где:** Папка `lib/Новая папка/` — копии файлов из `lib/` (api_service, auth_screen, server_config, settings_hub и т.д.).
- **Суть:** Два источника правды, риск расхождений и путаницы.
- **Исправление:** Удалить дубликаты и вести один код в `lib/`.

### 3.5 Логирование ответов API в прод
- **Где:** `lib/data/api_service.dart` — `_handleResponse` печатает в консоль тело и заголовки ответа.
- **Суть:** В проде это утечка данных и лишний шум.
- **Исправление:** Логировать только при `kDebugMode` или через условный логгер с уровнем.

---

## 4. Функциональные пробелы

### 4.1 Список заблокированных
- **Сервер:** Нет эндпоинта вида `GET /api/v1/users/blocked` (список кого я заблокировал).
- **Клиент:** Нет экрана/раздела «Чёрный список» с возможностью разблокировки.
- **Итог:** Разблокировать можно только через профиль того же пользователя; управлять списком блоков негде.

### 4.2 Текущая сессия на экране «Устройства»
- **Клиент:** В списке сессий не помечено «это устройство». Сервер не возвращает признак «текущая сессия» (нет привязки JWT/session_id к записи в `user_sessions` при логине).
- **Идея:** При логине создавать/обновлять запись в `user_sessions` с известным `id` и при выдаче JWT передавать в теле ответа `session_id`; клиент сохраняет и в списке устройств подсвечивает текущее. Либо на бэкенде помечать текущую сессию по какому-то заголовку/токену при вызове `GET /api/v1/sessions`.

### 4.3 Presence в реальном времени
- **Сервер:** При подключении/отключении WS обновляется `users.is_online` и `last_seen`, но другие клиенты не получают событие «user online/offline».
- **Клиент:** В профиле показываются «в сети»/«был недавно» по данным GET профиля, но без подписки на события присутствия обновление только при повторном заходе в профиль.
- **Идея:** Рассылать по WS (или Redis pub/sub) событие presence при смене онлайн-статуса; клиент подписывается и обновляет индикаторы без перезагрузки профиля.

### 4.4 Настройка «Показывать онлайн»
- **Сервер:** Учитывается `settings.show_online` в profile и search — при `false` возвращаются `is_online: false`, `last_seen: null`. Где в БД выставляется `settings` — не проверялось; если нет эндпоинта/логики обновления, пользователь не может включить/выключить показ онлайн.
- **Клиент:** В настройках есть пункты вроде «Скрыть время последнего посещения» — нужно убедиться, что они пишут в `users.settings` (например, через `PUT /users/me` с полем `settings`) и что ключ именно `show_online`.

---

## 5. Краткая сводка

| Категория | Проблема | Критичность |
|-----------|----------|-------------|
| Клиент | `ServerConfig.baseUrl` отсутствует | Высокая |
| Бэкенд | Crypto-auth маршруты не в роутере | Высокая |
| Бэкенд | IP в сессиях не сохраняется | Средняя |
| Бэкенд | Кик сессии не отзывает JWT/WS | Средняя |
| Бэкенд | Два файла миграции 0002_* | Средняя |
| Клиент | «Пожаловаться» в канале не вызывает API | Средняя |
| Клиент | Нет жалобы на сообщение в чате | Средняя |
| Конфиг | Захардкоженный IP сервера | Средняя |
| Код | Дубликаты в `lib/Новая папка/` | Низкая |
| Код | Логи тел ответов в api_service | Низкая |
| Функции | Нет списка заблокированных и экрана ЧС | Низкая |
| Функции | Не помечено «это устройство» в сессиях | Низкая |
| Функции | Нет real-time presence событий | Низкая |

Рекомендуемый порядок: сначала исправить 1.1 и 1.2, затем 2.1–2.3 и 3.1–3.2, после этого — конфиг, дубликаты и улучшения по списку блоков/сессий/presence.
