# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Rich Features - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç

## ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. WebSocket Typing Events ‚úÖ
- **Backend**: –°–æ–±—ã—Ç–∏–µ `Typing` –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ `server/src/ws/events.rs`
- **Backend**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ `server/src/ws/handler.rs`
- **Flutter**: –ú–µ—Ç–æ–¥ `sendTyping()` –≤ `WebSocketService`
- **Flutter**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `ChatScreen` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
- **Flutter**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö typing events –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —á–∞—Ç–∞

**–§–∞–π–ª—ã:**
- `lib/data/services/websocket_service.dart` - –¥–æ–±–∞–≤–ª–µ–Ω `sendTyping()`
- `lib/features/chat_screen.dart` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è typing events

### 2. –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ (Drafts) ‚úÖ
- **Flutter**: –°–µ—Ä–≤–∏—Å `DraftService` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
- **–§—É–Ω–∫—Ü–∏–∏**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø–æ–ª—É—á–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
- **–•—Ä–∞–Ω–µ–Ω–∏–µ**: SharedPreferences —Å –∫–ª—é—á–∞–º–∏ `draft_{chatId}`

**–§–∞–π–ª—ã:**
- `lib/data/draft_service.dart` - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ ChatScreen:**
```dart
// –í initState:
final draft = await DraftService.getDraft(widget.chatId);
if (draft != null) {
  _controller.text = draft;
}

// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:
await DraftService.deleteDraft(widget.chatId);

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ (—Å debounce):
_onTextChanged() {
  Timer(Duration(seconds: 1), () {
    DraftService.saveDraft(widget.chatId, _controller.text);
  });
}
```

### 3. –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ ‚úÖ
- **Flutter**: –≠–∫—Ä–∞–Ω `DevModeScreen` —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
- **–§—É–Ω–∫—Ü–∏–∏**:
  - –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (–≤–µ—Ä—Å–∏—è, build, package)
  - –ü–æ–∫–∞–∑ –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (Fingerprint, Device ID)
  - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ (Prod/Dev/Localhost)
  - –ü–æ–∫–∞–∑ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
  - –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª—ã:**
- `lib/features/dev_mode_screen.dart` - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `lib/data/server_config.dart` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã `setApiBaseUrl()` –∏ `init()`

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ 5 —Ç–∞–ø–æ–≤ –Ω–∞ –≤–µ—Ä—Å–∏—é:
```dart
GestureDetector(
  onTap: () {
    _tapCount++;
    if (_tapCount >= 5) {
      Navigator.push(context, MaterialPageRoute(
        builder: (_) => DevModeScreen(),
      ));
      _tapCount = 0;
    }
  },
  child: Text('–í–µ—Ä—Å–∏—è ${packageInfo.version}'),
)
```

### 4. Background Worker –¥–ª—è –∏—Å—á–µ–∑–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ‚úÖ
- **Backend**: Worker `expiring_messages` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–§—É–Ω–∫—Ü–∏—è**: –£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å `expires_at < now()`
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞

**–§–∞–π–ª—ã:**
- `server/src/workers/expiring_messages.rs` - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è worker
- `server/src/workers/mod.rs` - –º–æ–¥—É–ª—å workers
- `server/src/main.rs` - –∑–∞–ø—É—Å–∫ worker

### 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (Markdown) ‚úÖ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫
- –ë–ª–æ–∫–∏ –∫–æ–¥–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π

### 6. Backend API –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π ‚úÖ
- –í—Å–µ endpoints —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

## üîÑ –¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. Pinned Messages UI
**Backend –≥–æ—Ç–æ–≤**, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –ü–æ–ª–µ `pinnedMessageId` –≤ –º–æ–¥–µ–ª—å `ChatThread`
- API –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è/—É—Å—Ç–∞–Ω–æ–≤–∫–∏ pinned message
- UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ `ChatScreen` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è pinned message –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º

**–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
```dart
// –í ChatThread model:
final String? pinnedMessageId;

// –í ChatScreen –ø–æ—Å–ª–µ AppBar:
if (chat.pinnedMessageId != null) {
  final pinnedMsg = chat.messages.firstWhere(
    (m) => m.id == chat.pinnedMessageId,
    orElse: () => null,
  );
  if (pinnedMsg != null) {
    _PinnedMessageBubble(message: pinnedMsg),
  }
}
```

### 2. Link Preview —Å –ø—Ä–æ–∫—Å–∏
**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
- Backend endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è OpenGraph –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
- Flutter –≤–∏–¥–∂–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `_FormattedText` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∫–∞–∑–∞ –ø—Ä–µ–≤—å—é

**Backend endpoint (–ø—Ä–∏–º–µ—Ä):**
```rust
// server/src/web/messages/handlers.rs
pub async fn get_link_preview(
    Query(q): Query<LinkPreviewQuery>,
) -> Result<impl IntoResponse, ApiError> {
    // –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
    // –ü–∞—Ä—Å–∏–Ω–≥ OpenGraph
    // –í–æ–∑–≤—Ä–∞—Ç title, image, description
}
```

### 3. UI –¥–ª—è Edit/Delete
**Backend –≥–æ—Ç–æ–≤**, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ -> –º–µ–Ω—é —Å "–ò–∑–º–µ–Ω–∏—Ç—å" –∏ "–£–¥–∞–ª–∏—Ç—å"
- –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä:**
```dart
onLongPress: () {
  showCupertinoModalPopup(
    context: context,
    builder: (context) => CupertinoActionSheet(
      actions: [
        if (message.isMe && _canEdit(message))
          CupertinoActionSheetAction(
            child: Text('–ò–∑–º–µ–Ω–∏—Ç—å'),
            onPressed: () => _editMessage(message),
          ),
        if (message.isMe)
          CupertinoActionSheetAction(
            isDestructiveAction: true,
            child: Text('–£–¥–∞–ª–∏—Ç—å'),
            onPressed: () => _deleteMessage(message),
          ),
      ],
    ),
  );
}
```

## üìù –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### –ò—Å—á–µ–∑–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (UI)
- –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞
- UI —Ç–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ —Ä—è–¥–æ–º —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
- FTS –≤ PostgreSQL –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º

### –ú—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- UI –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

### –ò–∑–±—Ä–∞–Ω–Ω–æ–µ/–ó–∞–º–µ—Ç–∫–∏
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç —Ç–∏–ø–∞ "cloud"
- UI –¥–ª—è "Saved Messages"

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
- Android: `FlutterWindowManager.addFlags(FLAG_SECURE)`
- iOS: —Ä–∞–∑–º—ã—Ç–∏–µ –≤ Task Switcher

### –õ–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π PIN –∫–æ–¥
- –õ–æ–≥–∏–∫–∞ —Å–∫—Ä—ã—Ç–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –≤ ChatScreen** - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
2. **–î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è pinned messages** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å link preview** - backend endpoint + UI
4. **–î–æ—Ä–∞–±–æ—Ç–∞—Ç—å UI –¥–ª—è edit/delete** - –º–µ–Ω—é –∏ –¥–∏–∞–ª–æ–≥–∏
5. **–î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—á–µ–∑–∞—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π** - UI –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `pubspec.yaml`:
- `package_info_plus: ^8.0.0` - –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ ServerConfig

`getApiBaseUrl()` —Ç–µ–ø–µ—Ä—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:
- `getApiBaseUrlAsync()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
- `setApiBaseUrl()` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ URL (–¥–ª—è dev mode)
- `init()` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–í–∞–∂–Ω–æ:** –í—ã–∑–≤–∞—Ç—å `ServerConfig.init()` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ URL.

