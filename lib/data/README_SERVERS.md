# Серверная архитектура Mimu

## Обзор

Система серверов с доменами-заглушками для отправки сообщений, загрузки файлов и синхронизации данных.

## Структура файлов

### `server_config.dart`
Конфигурация серверов с доменами-заглушками:
- `messageServer` - основной сервер для сообщений и чатов
- `fileServer` - сервер для загрузки и хранения файлов
- `mediaServer` - сервер для медиа (изображения, видео)
- `voiceServer` - сервер для голосовых сообщений
- `syncServer` - сервер для синхронизации данных

### `api_service.dart`
Базовый сервис для работы с API:
- HTTP методы (GET, POST, PUT, DELETE)
- Загрузка файлов с прогрессом
- Скачивание файлов
- Обработка ошибок
- Повторные попытки запросов

### `message_api.dart`
API для работы с сообщениями:
- Отправка текстовых сообщений
- Отправка медиа (изображения, видео)
- Отправка голосовых сообщений
- Отправка файлов
- Редактирование сообщений
- Удаление сообщений
- Реакции на сообщения
- Получение сообщений
- Пересылка сообщений

### `file_api.dart`
API для работы с файлами:
- Загрузка файлов на сервер
- Скачивание файлов с сервера
- Получение информации о файле
- Удаление файлов
- Специализированные методы для изображений, видео, голосовых сообщений

### `sync_service.dart`
Сервис для синхронизации данных:
- Автоматическая синхронизация всех чатов
- Синхронизация конкретного чата
- Принудительная синхронизация

## Интеграция

### ChatStore
`ChatStore` автоматически отправляет сообщения на сервер при добавлении:
- Текстовые сообщения
- Изображения (сначала загружается файл, затем отправляется сообщение)
- Голосовые сообщения
- Файлы

### Настройки
В `SettingsService` добавлена настройка `syncEnabled` для включения/выключения синхронизации.

## Использование

### Отправка сообщения
```dart
final store = context.read<ChatStore>();
final message = ChatMessage(
  id: DateTime.now().millisecondsSinceEpoch.toString(),
  type: ChatMessageType.text,
  text: 'Привет!',
  isMe: true,
  timestamp: DateTime.now(),
);
await store.addMessage(chatId, message);
// Сообщение автоматически отправится на сервер
```

### Загрузка файла
```dart
final fileApi = FileApi();
final result = await fileApi.uploadImage(
  file: File('/path/to/image.jpg'),
  onProgress: (sent, total) {
    print('Progress: ${(sent / total * 100).toStringAsFixed(1)}%');
  },
);

if (result['success'] == true) {
  final fileId = result['fileId'];
  // Используйте fileId для отправки сообщения
}
```

### Синхронизация
```dart
final syncService = SyncService();
await syncService.syncChat(chatStore, chatId);
// Или синхронизация всех чатов
await syncService.syncAllChats(chatStore);
```

## Обработка ошибок

Все API методы возвращают `Map<String, dynamic>` с полем `success`:
- `success: true` - операция успешна, данные в поле `data`
- `success: false` - ошибка, информация в полях `error` и `message`

Ошибки отправки на сервер не блокируют локальное сохранение сообщений.

## Повторные попытки

Автоматические повторные попытки для:
- Сетевых ошибок
- Ошибок сервера (5xx)
- Таймаутов

Не повторяются для клиентских ошибок (4xx).

## Домены-заглушки

Текущие домены являются заглушками и должны быть заменены на реальные при развертывании:
- `https://api.mimu.chat`
- `https://files.mimu.chat`
- `https://media.mimu.chat`
- `https://voice.mimu.chat`
- `https://sync.mimu.chat`

